---
title: "Inspection Outcome by Roof Columns"
author: "Priyanka Goel"
date: "2025-09-07"
output: html_document
---

```{r setup, include=FALSE}
# This chunk sets up the document and loads the reticulate package
# which allows R to run Python code.
knitr::opts_chunk$set(echo = TRUE)
library(reticulate)
```


```{python}
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns



def create_side_by_side_chart(df, feature_col, inspection_col, title):
    
    crosstab = pd.crosstab(df[feature_col], df[inspection_col])
    
    # Calculate relative frequencies (percentages)
    percentage_crosstab = crosstab.div(crosstab.sum(axis=1), axis=0) * 100
    
    print(f"--- Relative Frequencies (%) for {title} ---")
    print(percentage_crosstab.round(1))
    print("\\n" + "="*60 + "\\n")
    
    # Get totals for annotation
    totals = crosstab.sum(axis=1)
    
    # --- Create the Plot ---
    sns.set_style("whitegrid")
    ax = percentage_crosstab.plot(
        kind='bar', 
        stacked=False,
        figsize=(12, 7),
        colormap='viridis',
        width=0.8
    )
    
    # Add percentage labels
    for container in ax.containers:
        ax.bar_label(container, labels=[f'{v:.1f}%' for v in container.datavalues], padding=3, fontsize=9)

    # Create new x-axis labels with total count (N)
    new_xtick_labels = [f'{label.get_text()}(N={totals[label.get_text()]})' for label in ax.get_xticklabels()]
    ax.set_xticklabels(new_xtick_labels)
        
    # --- Final Touches ---
    ax.set_title(title, fontsize=16, weight='bold')
    ax.set_xlabel(feature_col.split('[')[-1].replace(']','').strip(), fontsize=12)
    ax.set_ylabel('Percentage of Homes (%)', fontsize=12)
    ax.set_ylim(0, max(percentage_crosstab.max()) * 1.3) # Adjust y-axis for labels
    ax.legend(title=inspection_col, bbox_to_anchor=(1.02, 1), loc='upper left')
    plt.xticks(rotation=0, ha='center')
    plt.tight_layout()
    plt.show()


# --- 1) Load data ---
df = pd.read_excel('CAMCOS and HIZ.xlsx', sheet_name='Field data', header=1)

# 1. Roof Status vs. Inspection Outcome
create_side_by_side_chart(df, 
                           'Roof status', 
                           'Did it pass the most recent cal fire inspection?',
                           'Inspection Outcome Rates by Overall Roof Status')

# 2. Roof and Gutters Free of Fuel vs. Inspection Outcome
fuel_col = 'Roof structure? (absent is that feature does not exist, satisfactory and maintenance is that the feature exists eg bird stops not needed on asphalt roof) [Roof and gutters free of fuel]'
create_side_by_side_chart(df, 
                           fuel_col, 
                           'Did it pass the most recent cal fire inspection?',
                           'Inspection Outcome Rates by Fuel in Roof/Gutters')

# 3. Bird Stops vs. Inspection Outcome
bird_stops_col = 'Roof structure? (absent is that feature does not exist, satisfactory and maintenance is that the feature exists eg bird stops not needed on asphalt roof) [Bird stops]'
create_side_by_side_chart(df, 
                           bird_stops_col, 
                           'Did it pass the most recent cal fire inspection?',
                           'Inspection Outcome Rates by Bird Stop Status')
# 4. Metal roof vs. Inspection Outcome
metal_roof_col= 'Roof material? Focus on material e.g. loose shingles or tiles, caulking, etc. rather than fuel. [Metal roof]'
create_side_by_side_chart(df, 
                           metal_roof_col, 
                           'Did it pass the most recent cal fire inspection?',
                           'Inspection Outcome Rates by Metal Roofing')

```



**1. Overall Roof Status**

Insight: A "good" roof is surprisingly associated with a higher inspection failure rate (32%) than a roof that "needs maintenance" (17%).

In a nutshell: A good roof can't save a home from failing if other major problems exist.

**2. Fuel in Roof and Gutters**

Insight: Similar to the overall status, clean gutters ("Satisfactory") are linked to a higher failure rate (24%) than dirty gutters ("Needs maintenance" at 14%).

In a nutshell: Gutter debris is a minor, fixable issue. Homes are failing for bigger, more fundamental reasons, making this a poor predictor on its own.

**3. Bird Stops**

Insight: The absence of required "bird stops" results in a 0% failure rate but also a low 31% pass rate, with the vast majority (69%) being "Uncertain."

In a nutshell: Missing bird stops is a major red flag for inspectors that prevents a clear "Pass," indicating it's a critical structural vulnerability.

**4. Metal Roof**

Insight: A metal roof that "Needs maintenance" has an 80% failure rate.

In a nutshell: While the sample size is small, a metal roof in poor condition is a very strong predictor of failing the inspection.
